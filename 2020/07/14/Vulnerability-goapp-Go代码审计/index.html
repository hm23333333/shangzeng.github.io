<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="ShangZeng">





<title>Vulnerability-goapp-Go代码审计 | ShangZeng</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">ShangZeng&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/friends">Friends</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ShangZeng&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/friends">Friends</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Vulnerability-goapp-Go代码审计</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">ShangZeng</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">July 14, 2020&nbsp;&nbsp;15:46:31</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Golang/">Golang</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>查找资料，学习golang的代码审计。漏洞类型是相似的，主要是学习golang漏洞代码中的表现形式。</p>
<p><a href="https://github.com/Hardw01f/Vulnerability-goapp" target="_blank" rel="noopener">Vulnerability-goapp</a>是模拟漏洞的一个靶场。</p>
<h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><p>作者提供docker，不建议使用源码（作者数据库结构没给，而且数据库连接一大堆地方。。。。）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git clone https://github.com/Hardw01f/Vulnerability-goapp.git</span><br><span class="line">cd Vulnerability-goapp</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><h4 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h4><p>访问main.go入口文件，看见如下代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http.Handle 路由  http.StripPrefix 进行路径分层(处理映射)  http.FileServer 显示当亲路径</span></span><br><span class="line">http.Handle(<span class="string">"/assets/"</span>, http.StripPrefix(<span class="string">"/assets/"</span>, http.FileServer(http.Dir(<span class="string">"assets/"</span>))))</span><br></pre></td></tr></table></figure>
<p>emmm其实也不算什么问题，就是单纯记录下：</p>
<p><img src="https://www.shangzeng.club/WechatIMG786.png" alt="image"></p>
<h4 id="反射型XSS-【一】"><a href="#反射型XSS-【一】" class="headerlink" title="反射型XSS - 【一】"></a>反射型XSS - 【一】</h4><p>mian.go </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, sayYourName)  <span class="comment">// 当前网址执行 sayYourName 函数</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayYourName</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	r.ParseForm()                                              <span class="comment">// 解析表单</span></span><br><span class="line">	fmt.Println(r.Form)</span><br><span class="line">	fmt.Println(<span class="string">"path"</span>, r.URL.Path)</span><br><span class="line">	fmt.Println(<span class="string">"scheme"</span>, r.URL.Scheme)</span><br><span class="line">	fmt.Println(<span class="string">"r.Form"</span>, r.Form)</span><br><span class="line">	fmt.Println(<span class="string">"r.Form[name]"</span>, r.Form[<span class="string">"name"</span>])</span><br><span class="line">	<span class="keyword">var</span> Name <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> r.Form &#123;                                 <span class="comment">// 遍历提交数据键值对</span></span><br><span class="line">		fmt.Println(<span class="string">"key:"</span>, k)</span><br><span class="line">		Name = strings.Join(v, <span class="string">","</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(Name)</span><br><span class="line">	fmt.Fprintf(w, Name)                                       <span class="comment">// 输出，存在XSS</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="https://www.shangzeng.club/WechatIMG12135.png" alt="image"></p>
<h4 id="存储型XSS-【一】"><a href="#存储型XSS-【一】" class="headerlink" title="存储型XSS - 【一】"></a>存储型XSS - 【一】</h4><p>在login界面找到注册请求是/new,在main.go中查找路由</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/new"</span>, register.NewUserRegister)</span><br></pre></td></tr></table></figure>

<p>跟进函数 /pkg/register.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewUserRegister</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"GET"</span> &#123;</span><br><span class="line">		t, _ := template.ParseFiles(<span class="string">"./views/public/new.gtpl"</span>)</span><br><span class="line">		t.Execute(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		r.ParseForm()</span><br><span class="line">		fmt.Println(r.FormValue(<span class="string">"mail"</span>))</span><br><span class="line">		fmt.Println(r.FormValue(<span class="string">"name"</span>))</span><br><span class="line">		fmt.Println(r.FormValue(<span class="string">"age"</span>))</span><br><span class="line">		fmt.Println(r.FormValue(<span class="string">"passwd"</span>))</span><br><span class="line">		<span class="keyword">if</span> CheckUserDeplicate(r.FormValue(<span class="string">"mail"</span>)) &#123;                                    <span class="comment">// 检查邮件是否重复</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> RegisterUser(r) &#123;                                                        <span class="comment">// 跟进 RegisterUser</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterUser</span><span class="params">(r *http.Request)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:rootwolf@tcp(mysql)/vulnapp"</span>)                    <span class="comment">// 连接数据库</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	age, err := strconv.Atoi(r.FormValue(<span class="string">"age"</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 向表格中插入新的行 这里我们写入什么数据就直接执行  </span></span><br><span class="line">	_, err = db.Exec(<span class="string">"insert into user (name,mail,age,passwd) value(?,?,?,?)"</span>, r.FormValue(<span class="string">"name"</span>), r.FormValue(<span class="string">"mail"</span>), age, r.FormValue(<span class="string">"passwd"</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.shangzeng.club/WechatIMG12143.png" alt="image"></p>
<p>触发点在top路由：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">"/top"</span>, showUserTopPage)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">showUserTopPage</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	userName, sessionID, userID, err := cookie.GetUserIDFromCookie(r）  <span class="comment">// GetUserIDFromCookie 从数据库中请求</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cookie.CheckSessionsCount(userID, sessionID) &#123;</span><br><span class="line">		login.StoreSID(userID, sessionID)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"not register sessionID"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> sessionID == <span class="string">""</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"sid not exist"</span>)</span><br><span class="line">		t, _ := template.ParseFiles(<span class="string">"./views/public/error.gtpl"</span>)</span><br><span class="line">		t.Execute(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r.Method == <span class="string">"GET"</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> userID != <span class="number">0</span> &#123;</span><br><span class="line">				uid := strconv.Itoa(userID)</span><br><span class="line">				cookieUserID := &amp;http.Cookie&#123;</span><br><span class="line">					Name:  <span class="string">"UserID"</span>,</span><br><span class="line">					Value: uid,</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				deleAdminID := &amp;http.Cookie&#123;</span><br><span class="line">					Name:  <span class="string">"adminSID"</span>,</span><br><span class="line">					Value: <span class="string">""</span>,</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				http.SetCookie(w, cookieUserID)</span><br><span class="line">				http.SetCookie(w, deleAdminID)</span><br><span class="line">				p := Person&#123;UserName: userName&#125;        <span class="comment">// 没有过滤，</span></span><br><span class="line">				t, _ := template.ParseFiles(<span class="string">"./views/public/top.gtpl"</span>)</span><br><span class="line">				t.Execute(w, p)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			http.NotFound(w, r)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以此类推，后台后很多的触发点。</p>
<h4 id="存储型XSS-【二】"><a href="#存储型XSS-【二】" class="headerlink" title="存储型XSS - 【二】"></a>存储型XSS - 【二】</h4><p>后台用户编辑处存在XSS，路由为/profile/edit/confirm</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/profile/edit/confirm"</span>, user.ShowEditConfirm)</span><br></pre></td></tr></table></figure>

<p>跟进 usermanager.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShowEditConfirm</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> cookie.CheckSessionID(r) &#123;</span><br><span class="line">			fmt.Println(r.Referer())</span><br><span class="line">			userName := r.FormValue(<span class="string">"username"</span>)</span><br><span class="line">			age := r.FormValue(<span class="string">"age"</span>)</span><br><span class="line">			mail := r.FormValue(<span class="string">"mail"</span>)</span><br><span class="line">			fmt.Println(<span class="string">"mail : "</span>, mail)</span><br><span class="line">			address := r.FormValue(<span class="string">"address"</span>)  </span><br><span class="line">			animal := r.FormValue(<span class="string">"animal"</span>)</span><br><span class="line">			word := r.FormValue(<span class="string">"word"</span>)</span><br><span class="line">			userAge, err := strconv.Atoi(age)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			_, _, uid, err := cookie.GetCookieValue(r)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">				http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			userMail, _, err := GetUserInfos(uid)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			userImage, _, _, _, err := GetUserMoreDetails(uid)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line">				http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			u := User&#123;UserName: userName, Mail: userMail, Age: userAge, Image: userImage, Address: address, Animal: animal, Word: word&#125;</span><br><span class="line"></span><br><span class="line">			t, _ := template.ParseFiles(<span class="string">"./views/users/users_confirm.gtpl"</span>)</span><br><span class="line">			t.Execute(w, u)  <span class="comment">// 没有过滤 直接引用</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.shangzeng.club/WechatIMG12145.png" alt="image"></p>
<h4 id="存储型XSS-【三】"><a href="#存储型XSS-【三】" class="headerlink" title="存储型XSS - 【三】"></a>存储型XSS - 【三】</h4><p>search.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchPosts</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		searchWord := r.FormValue(<span class="string">"post"</span>)</span><br><span class="line">		fmt.Println(<span class="string">"value : "</span>, searchWord)</span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">		p := Results&#123;StringResults: removedExtraSpace&#125;</span><br><span class="line"></span><br><span class="line">		fmt.Println(p)</span><br><span class="line"></span><br><span class="line">		t, _ := template.ParseFiles(<span class="string">"./views/search/searchpost.gtpl"</span>)</span><br><span class="line">		t.Execute(w, p)</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.shangzeng.club/WechatIMG12149.png" alt="image"></p>
<h4 id="SQL注入-【一】"><a href="#SQL注入-【一】" class="headerlink" title="SQL注入 - 【一】"></a>SQL注入 - 【一】</h4><p>漏洞形成原理都是相通的，参数过滤没做好导致能执行sql语句。</p>
<p>跟进search.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchPosts</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		searchWord := r.FormValue(<span class="string">"post"</span>)</span><br><span class="line">		fmt.Println(<span class="string">"value : "</span>, searchWord)</span><br><span class="line">		testStr := <span class="string">"mysql -h mysql -u root -prootwolf -e 'select post,created_at from vulnapp.posts where post like \"%"</span> + searchWord + <span class="string">"%\"'"</span></span><br><span class="line"></span><br><span class="line">		fmt.Println(testStr)</span><br><span class="line"></span><br><span class="line">		testres, err := exec.Command(<span class="string">"sh"</span>, <span class="string">"-c"</span>, testStr).Output()</span><br><span class="line">		...</span><br></pre></td></tr></table></figure>
<p>使用命令执行sql语句，searchWord 并且没有过滤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123%&quot; and sleep(10)#</span><br></pre></td></tr></table></figure>
<p>跟踪数据，存在于搜索界面：</p>
<p><img src="https://www.shangzeng.club/WechatIMG12155.png" alt="image"></p>
<h4 id="命令执行-【一】"><a href="#命令执行-【一】" class="headerlink" title="命令执行 - 【一】"></a>命令执行 - 【一】</h4><p>这里大部分数据库查询使用的是<em>exec.Command</em>函数在命令行执行，如果参数可控就可能造成命令执行，跟进search.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchPosts</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		searchWord := r.FormValue(<span class="string">"post"</span>)</span><br><span class="line">		fmt.Println(<span class="string">"value : "</span>, searchWord)</span><br><span class="line">		testStr := <span class="string">"mysql -h mysql -u root -prootwolf -e 'select post,created_at from vulnapp.posts where post like \"%"</span> + searchWord + <span class="string">"%\"'"</span></span><br><span class="line"></span><br><span class="line">		fmt.Println(testStr)</span><br><span class="line"></span><br><span class="line">		testres, err := exec.Command(<span class="string">"sh"</span>, <span class="string">"-c"</span>, testStr).Output()</span><br><span class="line">		...</span><br></pre></td></tr></table></figure>

<p>构造命令执行语句,因为没回显，这里用DNSlog测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"'|ping alxaep.dnslog.cn|'"</span></span><br></pre></td></tr></table></figure>

<p>执行的时候需要编码一次（其他地方漏洞类似，就不重复举例子了）：</p>
<p><img src="https://www.shangzeng.club/WechatIMG787.png" alt="image"></p>
<h4 id="任意文件上传"><a href="#任意文件上传" class="headerlink" title="任意文件上传"></a>任意文件上传</h4><p>main.go</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/profile/edit/upload"</span>, uploader.UploadImage)</span><br></pre></td></tr></table></figure>

<p>跟进</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UploadImage</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		err := r.ParseMultipartForm(<span class="number">32</span> &lt;&lt; <span class="number">20</span>) <span class="comment">// 解析请求数据</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> cookie.CheckSessionID(r) &#123;</span><br><span class="line">			file, handler, err := r.FormFile(<span class="string">"uploadfile"</span>)  <span class="comment">// 解析数据格式，返回文件内容名字错误信息</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> file.Close()</span><br><span class="line">			f, err := os.OpenFile(<span class="string">"./assets/img/"</span>+handler.Filename, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> f.Close()</span><br><span class="line">			io.Copy(f, file)  <span class="comment">// 写入内容</span></span><br><span class="line">			UpdateDatabase(r, handler.Filename)</span><br><span class="line"></span><br><span class="line">			http.Redirect(w, r, <span class="string">"/profile"</span>, <span class="number">301</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上传文件名没有进行审核，导致任意文件上传漏洞</p>
<p><img src="https://www.shangzeng.club/WechatIMG788.png" alt="image"></p>
<p>文件也可以通过“../../”形式进行跨目录上传。</p>
<h4 id="CSRF-【一】"><a href="#CSRF-【一】" class="headerlink" title="CSRF - 【一】"></a>CSRF - 【一】</h4><p>存在很多处，比如密码修改和提交留言的地方，之类以提交留言为例子,使用burp生成CSRF的POC进行测试</p>
<p><img src="https://www.shangzeng.club/WechatIMG789.png" alt="image"></p>
<p>跟进 post.go 中的 ShowTimeline 函数</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShowTimeline</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> cookie.CheckSessionID(r) &#123;  <span class="comment">// 只是检查了cookie，没有防止CSRF的地方</span></span><br><span class="line">			_, _, uid, err := cookie.GetCookieValue(r)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">				http.NotFound(w, <span class="literal">nil</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			fmt.Println(uid, r.FormValue(<span class="string">"post"</span>))</span><br><span class="line"></span><br><span class="line">			postText := r.FormValue(<span class="string">"post"</span>)</span><br><span class="line"></span><br><span class="line">			fmt.Println(reflect.TypeOf(postText))</span><br><span class="line"></span><br><span class="line">			StorePost(uid, postText)</span><br><span class="line"></span><br><span class="line">			http.Redirect(w, r, <span class="string">"/timeline"</span>, <span class="number">301</span>)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>



<h4 id="CSRF-【二】"><a href="#CSRF-【二】" class="headerlink" title="CSRF - 【二】"></a>CSRF - 【二】</h4><p>密码修改处，基本逻辑是先在 /profile/changepasswd 中验证两次输入是否一致，再进入 /profile/compchangepasswd 写入，其中在 ConfirmPasswdChange 函数中对 Referer 进行了限制，但是并不影响CSRF的执行，这里主要写的就有毛病，按照正常的方式也修改不了密码…</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConfirmPasswdChange</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> cookie.CheckSessionID(r) &#123;</span><br><span class="line">			<span class="keyword">if</span> r.Referer() == <span class="string">"http://localhost:9090/profile/changepasswd"</span> &#123;</span><br><span class="line">				_, _, uid, err := cookie.GetCookieValue(r)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">"%+v\n"</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				newPasswd := r.FormValue(<span class="string">"passwd"</span>)</span><br><span class="line">				confirmPassword := r.FormValue(<span class="string">"confirm"</span>)</span><br><span class="line"></span><br><span class="line">				fmt.Println(newPasswd, confirmPassword, uid)</span><br><span class="line"></span><br><span class="line">				db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:rootwolf@tcp(mysql)/vulnapp"</span>)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">				_, err = db.Exec(<span class="string">"update vulnapp.user set passwd = ? where id = ?"</span>, newPasswd, uid)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>


<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>还存在一些越权漏洞，没什么学习价值就没写（主要参数都在cookie里面可以进行随意改动导致的越权）。</p>
<p>虽然代码乱糟糟的，但是总而言之还是学到了一些东西的，算是golang审计的一个小入门。</p>
<h3 id="参考资料-学习"><a href="#参考资料-学习" class="headerlink" title="参考资料/学习"></a>参考资料/学习</h3><ol>
<li><a href="https://xz.aliyun.com/t/7243#toc-15" target="_blank" rel="noopener">Vulnerability-goapp-Go语言漏洞平台审计过程</a></li>
<li><a href="https://github.com/Hardw01f/Vulnerability-goapp" target="_blank" rel="noopener">Vulnerability-goapp</a></li>
</ol>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>ShangZeng</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.shangzeng.club/2020/07/14/Vulnerability-goapp-Go%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">https://www.shangzeng.club/2020/07/14/Vulnerability-goapp-Go%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2020 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY<strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Golang/"># Golang</a>
                    
                        <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"># 代码审计</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/07/14/Go%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-gitea%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">Go代码审计-gitea远程命令执行</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© ShangZeng | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
